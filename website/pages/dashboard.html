<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة الطالب | سبشيال وان</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/assets/img/ا.png" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <meta name="theme-color" content="#1E88E5" />
  <style>
    /* Mobile app-like shell */
    .app-shell{ min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto; }
    .app-bottom-nav{ position:sticky; bottom:0; inset-inline:0; background:var(--card); border-top:1px solid var(--border); display:grid; grid-template-columns:repeat(5,1fr); gap:0; }
    .tab-btn{ appearance:none; background:none; border:0; padding:.75rem .25rem; display:flex; flex-direction:column; align-items:center; gap:.25rem; color:var(--muted); font-weight:600; cursor:pointer; }
    .tab-btn.active{ color:var(--primary); }
    .tab-icon{ font-size:1.2rem; }
    .app-section{ display:none; }
    .app-section.active{ display:block; }
    @media(min-width:900px){ .app-bottom-nav{ display:none; } }
  </style>
</head>
<body>
  <div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <a href="/" class="logo-link"><img src="/assets/img/ا.png" alt="Logo" class="logo" /></a>
      <div class="titles">
        <h1 class="app-title">لوحة الطالب</h1>
        <p class="subtitle">QR + الجداول + الإعلانات</p>
      </div>
    </div>
    <div class="header-actions">
      <button id="logout" class="btn ghost">خروج</button>
    </div>
  </header>

  <main class="container">
    <!-- Sections like a mobile app -->
    <section id="sec-home" class="app-section active" aria-labelledby="home-title">
      <h2 id="home-title" class="sr-only">الرئيسية</h2>
      <div class="card enter">
        <h3>مرحبًا <span id="st-name"></span></h3>
        <p style="color:var(--muted)">يمكنك استعراض QR الخاص بك، الجداول، والإعلانات من الأسفل.</p>
      </div>
    </section>
    <section id="sec-qr" class="app-section" aria-labelledby="qr-title">
      <h2 id="qr-title" class="sr-only">كود الحضور</h2>
      <div class="card enter">
        <h3>كود الحضور (QR)</h3>
        <div id="qrBox" class="qr">سيظهر QR هنا</div>
      </div>
    </section>
    <section id="sec-schedule" class="app-section" aria-labelledby="sched-title">
      <h2 id="sched-title" class="sr-only">الجداول</h2>
      <div class="card enter"><h3>الجداول</h3><div id="schedList" class="list"></div></div>
    </section>
    <section id="sec-ann" class="app-section" aria-labelledby="ann-title">
      <h2 id="ann-title" class="sr-only">الإعلانات</h2>
      <div class="card enter"><h3>الإعلانات</h3><div id="annList" class="list"></div></div>
    </section>
    <section id="sec-profile" class="app-section" aria-labelledby="prof-title">
      <h2 id="prof-title" class="sr-only">الملف الشخصي</h2>
      <div class="card enter">
        <h3>بياناتي</h3>
        <div id="profileBox" class="list"></div>
        <div style="display:flex;justify-content:flex-end;gap:.5rem;margin-top:.5rem">
          <button id="logoutBtn" class="btn">خروج</button>
        </div>
      </div>
    </section>
  </main>

  <nav class="app-bottom-nav" aria-label="قائمة تبويبات">
    <button class="tab-btn active" data-tab="home"><span class="tab-icon">🏠</span><span>الرئيسية</span></button>
    <button class="tab-btn" data-tab="qr"><span class="tab-icon">🧾</span><span>QR</span></button>
    <button class="tab-btn" data-tab="schedule"><span class="tab-icon">📅</span><span>الجداول</span></button>
    <button class="tab-btn" data-tab="ann"><span class="tab-icon">🔔</span><span>الإعلانات</span></button>
    <button class="tab-btn" data-tab="profile"><span class="tab-icon">👤</span><span>حسابي</span></button>
  </nav>
  </div>

  <script src="/assets/js/app.js"></script>
  <script>
    // Route guard: require login
    (function guard(){
      try{
        const token = localStorage.getItem('token');
        const stRaw = localStorage.getItem('student');
        if(!token || !stRaw){ window.location.href = '/pages/login.html?redirect=dashboard'; return; }
        window.__student = JSON.parse(stRaw);
      }catch{ window.location.href = '/pages/login.html?redirect=dashboard'; return; }
    })();

    // Tabs
    const tabs = document.querySelectorAll('.tab-btn');
    const sections = {
      home: document.getElementById('sec-home'),
      qr: document.getElementById('sec-qr'),
      schedule: document.getElementById('sec-schedule'),
      ann: document.getElementById('sec-ann'),
      profile: document.getElementById('sec-profile')
    };
    tabs.forEach(btn=> btn.onclick = ()=>{
      tabs.forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      Object.values(sections).forEach(s=> s.classList.remove('active'));
      const k = btn.getAttribute('data-tab');
      if(sections[k]) sections[k].classList.add('active');
    });

    // Fill student info and logout
    (function initProfile(){
      const st = window.__student || {};
      const nameEl = document.getElementById('st-name'); if(nameEl) nameEl.textContent = st.fullName || st.username || '';
      const prof = document.getElementById('profileBox');
      if(prof){
        const rows = [
          ['الاسم', st.fullName||'-'],
          ['اسم المستخدم', st.username||'-'],
          ['المرحلة', st.stage||'-'],
          ['السنتر', st.center||'-'],
          ['الكود', st.code||'-'],
          ['QR ID', st.qrId||'-']
        ];
        prof.innerHTML=''; rows.forEach(([k,v])=>{ const d=document.createElement('div'); d.className='item'; d.textContent=`${k}: ${v}`; prof.appendChild(d); });
      }
      const logoutBtn = document.getElementById('logoutBtn');
      if(logoutBtn){ logoutBtn.onclick = ()=>{ localStorage.removeItem('token'); localStorage.removeItem('student'); window.location.href = '/pages/login.html'; }; }
      const logoutTop = document.getElementById('logout');
      if(logoutTop){ logoutTop.onclick = ()=>{ localStorage.removeItem('token'); localStorage.removeItem('student'); window.location.href = '/pages/login.html'; }; }
    })();

    // QR render via external service
    (function renderQr(){
      const box = document.getElementById('qrBox'); if(!box) return;
      const st = window.__student || {}; const val = st.qrId || (st.code? String(st.code):'');
      if(!val){ box.textContent='لا يوجد QR'; return; }
      const img = document.createElement('img'); img.alt='QR'; img.loading='lazy';
      img.src = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent('so1:qr:'+val)}`;
      box.innerHTML=''; box.appendChild(img);
    })();

    // Load schedules and announcements
    (async function loadData(){
      try{
        const sched = await API.apiFetch('/api/schedules', {}, { retries: 2, timeout: 9000 }).then(r=>r.json());
        const l = document.getElementById('schedList'); if(l){ l.innerHTML=''; (sched||[]).slice(0,30).forEach(s=>{ const d=document.createElement('div'); d.className='item'; d.textContent=`${s.subject} — ${s.date} ${s.time} — ${s.center}`; l.appendChild(d); }); }
      }catch{}
      try{
        const ann = await API.apiFetch('/api/announcements', {}, { retries: 2, timeout: 9000 }).then(r=>r.json());
        const a = document.getElementById('annList'); if(a){ a.innerHTML=''; (ann||[]).slice(0,30).forEach(n=>{ const d=document.createElement('div'); d.className='item'; d.textContent=n.text||n.title; a.appendChild(d); }); }
      }catch{}
    })();
  </script>
</body>
</html>