<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Ø³Ø¨Ø´ÙŠØ§Ù„ ÙˆØ§Ù†</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../website/assets/css/styles.css" />
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <div class="titles">
        <h1 class="app-title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      </div>
    </div>
    <div class="header-actions">
      <button id="logout" class="btn ghost">Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>
  <!-- math parallax overlay to match website theme -->
  <div class="math-parallax" aria-hidden="true">âˆ«  Ï€  Î£  âˆš  âˆ†</div>

  <main class="container">
    <div class="dashboard">
      <div class="card" style="grid-column:1/-1">
        <h3>Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr auto auto auto;gap:8px;align-items:center;margin-bottom:8px">
          <input id="st_code" class="search-input" inputmode="numeric" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ (Ù…Ø«Ø§Ù„ 2388)" />
          <input id="st_qrid" class="search-input" placeholder="Ø£Ùˆ Ø£Ø¯Ø®Ù„ QR ID (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
          <button id="findByCode" class="btn primary">ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯</button>
          <button id="findByQr" class="btn">ğŸ” Ø¨Ø­Ø« Ø¨Ù€ QR ID</button>
          <button class="btn" id="scrollToScanner">ğŸ“· ÙØªØ­ Ø§Ù„Ù…Ø§Ø³Ø­</button>
        </div>
        <div class="card" style="margin:0 0 8px;">
          <h4 style="margin:0 0 6px">Ø§Ù„Ù…Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„ÙˆØ­Ø©)</h4>
          <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;margin-bottom:6px">
            <select id="cam_select" class="filter-select"></select>
            <button id="cam_start" class="btn">â–¶ï¸ Ø¨Ø¯Ø¡</button>
            <button id="cam_stop" class="btn">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
          </div>
          <div style="position:relative;aspect-ratio:16/9;background:#000;border-radius:8px;overflow:hidden">
            <video id="cam_video" playsinline muted style="width:100%;height:100%;object-fit:cover"></video>
            <canvas id="cam_canvas" style="display:none"></canvas>
            <div id="cam_status" style="position:absolute;inset:0;display:flex;align-items:flex-end;justify-content:center;color:#fff;padding:.5rem;pointer-events:none;background:linear-gradient(180deg,transparent,rgba(0,0,0,.35))">Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø­â€¦</div>
          </div>
        </div>
        <div id="studentProfile"></div>
      </div>
      <div class="card">
        <h3>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
        <div class="list" id="pending"></div>
      </div>
      <div class="card">
        <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</h3>
        <div class="list" id="lessons"></div>
        <div style="margin-top:8px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:6px">
          <input id="ls_subject" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©" class="search-input" required/>
          <input id="ls_date" type="date" class="search-input" required/>
          <input id="ls_time" type="time" class="search-input" required/>
          <select id="ls_center" class="filter-select" required>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²</option>
            <option value="Ø³Ù†ØªØ± Ø§Ù„Ù†Ø¬Ø§Ø­">Ø³Ù†ØªØ± Ø§Ù„Ù†Ø¬Ø§Ø­</option>
            <option value="Ø³Ù†ØªØ± Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¨Ø±Ø§ÙŠÙ…">Ø³Ù†ØªØ± Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¨Ø±Ø§ÙŠÙ…</option>
            <option value="Ø³Ù†ØªØ± Ø§ÙƒØ³ÙÙˆØ±Ø¯">Ø³Ù†ØªØ± Ø§ÙƒØ³ÙÙˆØ±Ø¯</option>
            <option value="Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø´Ø±ÙˆÙ‚">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø´Ø±ÙˆÙ‚</option>
            <option value="Ø¬Ø³Ø± Ø§Ù„Ø³ÙˆÙŠØ³">Ø¬Ø³Ø± Ø§Ù„Ø³ÙˆÙŠØ³</option>
          </select>
          <input id="ls_teacher" placeholder="Ø§Ù„Ù…Ø¯Ø±Ø³" class="search-input" value="Ø£Ø­Ù…Ø¯ Ø³Ø§Ù…ÙŠ"/>
          <input id="ls_duration" placeholder="Ø§Ù„Ù…Ø¯Ø©" class="search-input" value="2 Ø³Ø§Ø¹Ø©"/>
          <button id="addLesson" class="btn primary">â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³</button>
        </div>
      </div>
      <div class="card">
        <h3>Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†</h3>
        <div class="list" id="students"></div>
      </div>
      <div class="card" style="grid-column:1/-1">
        <h3>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h3>
        <div class="list" id="ann"></div>
        <div style="margin-top:8px;display:grid;grid-template-columns:1fr auto auto auto auto;gap:6px">
          <input id="ann_title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†" class="search-input"/>
          <textarea id="ann_text" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†" class="search-input" rows="2" required></textarea>
          <select id="ann_type" class="filter-select">
            <option value="general">Ø¹Ø§Ù…</option>
            <option value="important">Ù…Ù‡Ù…</option>
            <option value="exam">Ø§Ù…ØªØ­Ø§Ù†</option>
            <option value="assignment">ÙˆØ§Ø¬Ø¨</option>
          </select>
          <label style="display:flex;align-items:center;gap:4px;white-space:nowrap;">
            <input type="checkbox" id="ann_important"/> Ù…Ù‡Ù…
          </label>
          <button id="addAnn" class="btn secondary">ğŸ“£ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†</button>
        </div>
      </div>
    </div>
  </main>

  <script>
  // Minimal UI helpers (overlay + offline banner)
  const BASE_API = (()=>{
    try{
      const origin = window.location.origin;
      if(origin) return origin;
    }catch{}
    return 'https://math-book-tpjz.vercel.app';
  })();
  let adminKey = localStorage.getItem('adminKey') || '';
  let adminJwt = localStorage.getItem('adminJwt') || '';
  const overlay = (()=>{
    let el = document.getElementById('global-overlay');
    if(!el){
      el = document.createElement('div');
      el.id='global-overlay';
      el.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.25);display:none;align-items:center;justify-content:center;z-index:10000';
      el.innerHTML='<div class="loading"><div class="spinner"></div><span style="color:white;margin-inline-start:.5rem">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...</span></div>';
      document.body.appendChild(el);
    }
    return {
      show(){ el.style.display='flex'; },
      hide(){ el.style.display='none'; }
    };
  })();
  let offlineBanner = document.getElementById('offline-banner');
  if(!offlineBanner){
    offlineBanner=document.createElement('div');
    offlineBanner.id='offline-banner';
    offlineBanner.style.cssText='position:fixed;inset-inline:0;top:0;z-index:10001;background:#fee2e2;color:#991b1b;border-bottom:1px solid #fca5a5;padding:.5rem 1rem;text-align:center;display:none';
    offlineBanner.textContent='ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
    document.body.appendChild(offlineBanner);
  }
  window.addEventListener('online', ()=>{ offlineBanner.style.display='none'; });
  window.addEventListener('offline', ()=>{ offlineBanner.style.display='block'; });

  async function apiFetch(path, options = {}, cfg = {}){
    const { retries = 1, timeout = 8000 } = cfg;
    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort(), timeout);
    const url = path.startsWith('http') ? path : `${BASE_API}${path}`;
    try{
      const headers = new Headers(options.headers || {});
      if(url.includes('/api/admin/')){
        if(!adminJwt){ adminJwt = localStorage.getItem('adminJwt') || ''; }
        if(adminJwt){ headers.set('Authorization', `Bearer ${adminJwt}`); }
        else {
          if(!adminKey){ adminKey = localStorage.getItem('adminKey') || ''; }
          if(adminKey){ headers.set('x-admin-key', adminKey); }
        }
      }
      const res = await fetch(url, { ...options, headers, signal: controller.signal });
      clearTimeout(timer);
      if(res.status === 401 && url.includes('/api/admin/')){
        localStorage.removeItem('adminJwt'); adminJwt='';
        location.href = './login.html';
      }
      return res;
    }catch(err){
      clearTimeout(timer);
      if(!navigator.onLine) offlineBanner.style.display='block';
      if(retries > 0){
        await new Promise(r => setTimeout(r, 600));
        return apiFetch(path, options, { retries: retries - 1, timeout });
      }
      throw err;
    }
  }
  (function ensureAuth(){
    if(!adminJwt && !adminKey){
      location.href = './login.html';
    }
  })();

  document.getElementById('logout').onclick=()=>{ localStorage.removeItem('adminKey'); localStorage.removeItem('adminJwt'); location.href='./login.html'; };

  // Student profile helpers
  function profileTpl(st){
    return `<div class="item enter" style="display:grid;gap:8px">
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <strong>${st.fullName||''}</strong>
          <div style="color:var(--muted);font-size:.85rem">@${st.username} â€” Ù…Ø±Ø­Ù„Ø©: ${st.stage||'-'} â€” Ø§Ù„Ø³Ù†ØªØ±: ${st.center||'-'}</div>
          <div style="color:var(--muted);font-size:.85rem">Ø§Ù„ÙƒÙˆØ¯: <strong id="st_code_val">${st.code||'-'}</strong> â€” QR ID: <code id="st_qrid_val" style="user-select:all">${st.qrId||'-'}</code></div>
          <div style="display:flex;gap:6px;margin-top:6px">
            <button class="btn" id="copy_code">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</button>
            <button class="btn" id="copy_qrid">ğŸ“‹ Ù†Ø³Ø® QR ID</button>
            <button class="btn secondary" id="print_card">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ§Ø±Øª Ø§Ù„Ø·Ø§Ù„Ø¨</button>
          </div>
          <div style="color:var(--muted);font-size:.85rem">ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±: ${st.parentPhone||'-'} â€” Ø§Ù„Ø·Ø§Ù„Ø¨: ${st.studentPhone||'-'}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr;gap:8px">
        <div class="card" style="margin:0">
          <h4 style="margin:0 0 6px">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h4>
          <div id="st_att" class="list"></div>
        </div>
        <div class="card" style="margin:0">
          <h4 style="margin:0 0 6px">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h4>
          <div id="st_res" class="list" style="margin-bottom:8px"></div>
          <div style="display:grid;grid-template-columns:1fr auto auto auto;gap:6px">
            <input id="res_name" class="search-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†"/>
            <input id="res_score" class="search-input" type="number" step="0.01" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©"/>
            <input id="res_max" class="search-input" type="number" step="0.01" placeholder="Ù…Ù†"/>
            <button id="addRes" class="btn secondary">â• Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø©</button>
          </div>
        </div>
      </div>
    </div>`;
  }

  async function loadProfileByCode(){
    const code = parseInt(document.getElementById('st_code').value,10);
    if(!code){ alert('Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§'); return; }
    try{
      overlay.show();
      const res = await apiFetch(`/api/admin/students/by-code/${code}`,{}, {retries:1, timeout:9000});
      if(!res.ok){ const j = await res.json().catch(()=>({})); throw new Error(j.message||'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨'); }
      const st = await res.json();
      renderStudentProfile(st);
    }catch(e){ alert(e.message||'ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø«'); }
    finally{ overlay.hide(); }
  }

  async function loadProfileByQrId(qrid){
    const id = qrid || document.getElementById('st_qrid').value.trim();
    if(!id){ alert('Ø£Ø¯Ø®Ù„ QR ID'); return; }
    try{
      overlay.show();
      const res = await apiFetch(`/api/admin/students/by-qr/${encodeURIComponent(id)}`,{}, {retries:1, timeout:9000});
      if(!res.ok){ const j = await res.json().catch(()=>({})); throw new Error(j.message||'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨'); }
      const st = await res.json();
      renderStudentProfile(st);
    }catch(e){ alert(e.message||'ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø«'); }
    finally{ overlay.hide(); }
  }

  async function renderStudentProfile(st){
    const wrap = document.getElementById('studentProfile');
    wrap.innerHTML = profileTpl(st);
    // Copy buttons
    const copy_code = document.getElementById('copy_code');
    const copy_qrid = document.getElementById('copy_qrid');
    const print_btn = document.getElementById('print_card');
    if(copy_code){ copy_code.onclick = ()=> copyToClipboard(String(st.code||'')); }
    if(copy_qrid){ copy_qrid.onclick = ()=> copyToClipboard(String(st.qrId||'')); }
    if(print_btn){ print_btn.onclick = ()=> printStudentCard(st); }
    // Attendance
    try{
      const att = await apiFetch(`/api/admin/students/${st.id}/attendance`,{}, {retries:1, timeout:9000}).then(r=>r.json());
      const attEl = document.getElementById('st_att');
      attEl.innerHTML = '';
      if(att && att.length){
        att.forEach(a=>{ const d=document.createElement('div'); d.className='item'; d.textContent = `${new Date(a.timestamp||a.scanned_at).toLocaleString('ar-EG')} â€” ${a.scannerId||a.scanner_id||''}`; attEl.appendChild(d); });
      }else{ attEl.innerHTML = '<div class="item">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¶ÙˆØ±</div>'; }
    }catch{}
    // Results
    try{
      const res = await apiFetch(`/api/admin/students/${st.id}/results`,{}, {retries:1, timeout:9000}).then(r=>r.json());
      const resEl = document.getElementById('st_res'); resEl.innerHTML='';
      if(res && res.length){ res.forEach(r=>{ const d=document.createElement('div'); d.className='item'; d.textContent = `${r.examName||r.exam_name}: ${r.score??'-'} / ${r.maxScore??'-'} â€” ${r.date}`; resEl.appendChild(d); }); }
      else{ resEl.innerHTML = '<div class="item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>'; }
    }catch{}
    // Add result handler
    const addBtn = document.getElementById('addRes');
    if(addBtn){
      addBtn.onclick = async ()=>{
        const examName = document.getElementById('res_name').value.trim();
        const score = document.getElementById('res_score').value;
        const maxScore = document.getElementById('res_max').value;
        if(!examName){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†'); return; }
        try{
          overlay.show();
          const resp = await apiFetch('/api/admin/results',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ studentId: st.id, examName, score: score?Number(score):null, maxScore: maxScore?Number(maxScore):null })
          }, {retries:1, timeout:9000});
          if(resp.ok){ alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØªÙŠØ¬Ø©'); renderStudentProfile(st); }
          else { const j = await resp.json().catch(()=>({})); alert(j.message||'ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØªÙŠØ¬Ø©'); }
        }catch(e){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); }
        finally{ overlay.hide(); }
      };
    }
  }

  function copyToClipboard(text){
    if(!text){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© Ù„Ù„Ù†Ø³Ø®'); return; }
    navigator.clipboard.writeText(text).then(()=>{
      alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®');
    }).catch(()=>{
      // fallback
      const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®'); }catch{ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®'); } document.body.removeChild(ta);
    });
  }

  // Load QR generator (for printing) if needed
  function loadQrGen(){
    return new Promise((resolve)=>{
      if (window.QRCode && window.QRCode.toCanvas) return resolve();
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js';
      s.onload=()=>resolve(); document.head.appendChild(s);
    });
  }

  async function printStudentCard(st){
    try{
      await loadQrGen();
      const payload = st.qrId ? `so1:qr:${st.qrId}` : String(st.code||'');
      // Prepare canvases
      const qrCanvas = document.createElement('canvas');
      await window.QRCode.toCanvas(qrCanvas, payload, { width: 360, margin: 2, errorCorrectionLevel:'M' });
      const W=960, H=540; // 16:9 card
      const c = document.createElement('canvas'); c.width=W; c.height=H; const ctx=c.getContext('2d');
      // Background
      ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,W,H);
      // Header gradient
      const grad=ctx.createLinearGradient(0,0,W,0); grad.addColorStop(0,'#1E88E5'); grad.addColorStop(1,'#7C4DFF');
      ctx.fillStyle=grad; ctx.fillRect(0,0,W,110);
      // Title
      ctx.fillStyle='#ffffff'; ctx.font='bold 36px Cairo, system-ui'; ctx.textAlign='center'; ctx.fillText('Special One â€” Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨', W/2, 70);
      // QR
      const qrSize=320; const qx=60, qy=160; ctx.drawImage(qrCanvas, qx, qy, qrSize, qrSize);
      // Info
      ctx.fillStyle='#0F172A'; ctx.textAlign='left';
      ctx.font='bold 42px Cairo, system-ui'; ctx.fillText(st.fullName||'Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±', 420, 230);
      ctx.font='28px Cairo, system-ui'; ctx.fillText(`@${st.username||''}`, 420, 270);
      ctx.font='32px Cairo, system-ui'; ctx.fillText(`Ø§Ù„ÙƒÙˆØ¯: ${st.code||'-'}`, 420, 320);
      ctx.font='24px Cairo, system-ui'; ctx.fillText(`QR ID: ${st.qrId||'-'}`, 420, 360);
      ctx.font='24px Cairo, system-ui'; ctx.fillText(`Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${st.stage||'-'} â€” Ø§Ù„Ø³Ù†ØªØ±: ${st.center||'-'}`, 420, 400);
      ctx.font='20px Cairo, system-ui'; ctx.fillStyle='#475569'; ctx.fillText('Ø£Ø­Ù…Ø¯ Ø³Ø§Ù…ÙŠ â€” Special One', 420, 440);
      // Border
      ctx.strokeStyle='#E5E7EB'; ctx.lineWidth=2; ctx.strokeRect(10,10,W-20,H-20);
      // Export
      const url = c.toDataURL('image/png');
      const a=document.createElement('a'); a.href=url; a.download=`student-card-${st.code||st.username||'so1'}.png`; a.click();
    }catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ§Ø±Øª'); }
  }

  document.getElementById('findByCode').onclick = loadProfileByCode;
  document.getElementById('findByQr').onclick = ()=> loadProfileByQrId();
  // Scroll to embedded scanner section
  (function(){
    const btn = document.getElementById('scrollToScanner');
    if(btn){
      btn.onclick = ()=>{
        const target = document.getElementById('cam_video');
        if(target){ target.scrollIntoView({ behavior:'smooth', block:'start' }); }
      };
    }
  })();

  // === In-panel Camera Scanner ===
  let camStream=null, scanTimer=null, detector=null;
  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput');
      const sel = document.getElementById('cam_select');
      sel.innerHTML = '';
      cams.forEach(c=>{ const o=document.createElement('option'); o.value=c.deviceId; o.textContent=c.label||'ÙƒØ§Ù…ÙŠØ±Ø§'; sel.appendChild(o); });
      if(!cams.length){ sel.innerHTML = '<option>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§Øª</option>'; }
    }catch{}
  }
  async function startCam(){
    try{
      await listCameras();
      const sel = document.getElementById('cam_select');
      const deviceId = sel.value || undefined;
      camStream && stopCam();
      camStream = await navigator.mediaDevices.getUserMedia({ video: deviceId? { deviceId: { exact: deviceId } } : { facingMode: 'environment' }, audio:false });
      const video = document.getElementById('cam_video');
      video.srcObject = camStream; await video.play();
      // Try BarcodeDetector
      if ('BarcodeDetector' in window) {
        try{ detector = new window.BarcodeDetector({ formats:['qr_code'] }); }catch{ detector = null; }
      }
      scanLoop();
      document.getElementById('cam_status').textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø³Ø­â€¦';
    }catch(e){ document.getElementById('cam_status').textContent = 'ØªØ¹Ø°Ù‘Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'; }
  }
  function stopCam(){
    if (scanTimer){ cancelAnimationFrame(scanTimer); scanTimer=null; }
    const video = document.getElementById('cam_video');
    if (video) { video.pause(); }
    if (camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
    document.getElementById('cam_status').textContent = 'Ù…ØªÙˆÙ‚Ù';
  }
  async function scanLoop(){
    const video = document.getElementById('cam_video');
    const canvas = document.getElementById('cam_canvas');
    const ctx = canvas.getContext('2d');
    if (video.readyState >= 2 && !video.paused){
      try{
        if (detector){
          const codes = await detector.detect(video);
          if (codes && codes.length){
            const raw = codes[0].rawValue || codes[0].raw || '';
            if (raw){ onQrDetected(raw); return; }
          }
        } else if (window.jsQR){
          canvas.width = video.videoWidth; canvas.height = video.videoHeight;
          ctx.drawImage(video,0,0,canvas.width,canvas.height);
          const img = ctx.getImageData(0,0,canvas.width,canvas.height);
          const code = window.jsQR(img.data, canvas.width, canvas.height);
          if (code && code.data){ onQrDetected(code.data); return; }
        }
      }catch{}
    }
    scanTimer = requestAnimationFrame(scanLoop);
  }
  let lastScanAt=0, lastVal='';
  function onQrDetected(val){
    const now = Date.now();
    if (val === lastVal && now - lastScanAt < 2500){ scanTimer = requestAnimationFrame(scanLoop); return; }
    lastVal = val; lastScanAt = now;
    document.getElementById('cam_status').textContent = 'ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· QR: Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØªØ­â€¦';
    // Expect payload to include qrId or be the qrId directly; try both
    // If payload like "so1:qr:<uuid>" extract the last segment
    let qrid = val;
    const m = String(val).match(/([0-9a-fA-F-]{36})/);
    if (m) qrid = m[1];
    loadProfileByQrId(qrid).then(()=>{
      document.getElementById('cam_status').textContent = 'ØªÙ… Ø§Ù„ÙØªØ­ â€” Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø³Ø­â€¦';
      scanTimer = requestAnimationFrame(scanLoop);
    }).catch(()=>{
      document.getElementById('cam_status').textContent = 'ØªØ¹Ø°Ù‘Ø± ÙØªØ­ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„';
      scanTimer = requestAnimationFrame(scanLoop);
    });
  }
  document.getElementById('cam_start').onclick = startCam;
  document.getElementById('cam_stop').onclick = stopCam;

  // Load jsQR fallback dynamically
  (function loadJsQr(){
    if ('BarcodeDetector' in window) return; // only if not supported
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
    s.async = true; document.head.appendChild(s);
  })();

  async function refresh(){
    try{
      const [pending, lessons, ann, students] = await Promise.all([
        apiFetch('/api/admin/pending', {}, { retries: 2, timeout: 9000 }).then(r=>r.json()),
        apiFetch('/api/schedules', {}, { retries: 2, timeout: 9000 }).then(r=>r.json()),
        apiFetch('/api/announcements', {}, { retries: 2, timeout: 9000 }).then(r=>r.json()),
        apiFetch('/api/admin/students', {}, { retries: 2, timeout: 9000 }).then(r=>r.json()),
      ]);
    const p = document.getElementById('pending'); p.innerHTML='';
    pending.forEach(s=>{
      const d = document.createElement('div'); d.className='item enter';
      d.innerHTML = `<strong>${s.fullName}</strong> â€” ${s.center} <div style="float:left;display:flex;gap:6px"><button data-id="${s.id}" class="btn primary a">âœ… Ù‚Ø¨ÙˆÙ„</button><button data-id="${s.id}" class="btn">âœ–ï¸ Ø±ÙØ¶</button></div>`;
      p.appendChild(d);
    });
    document.querySelectorAll('.a').forEach(b=>b.onclick=async()=>{ try{ overlay.show(); await apiFetch(`/api/admin/approve/${b.dataset.id}`,{method:'POST'},{ retries:1, timeout:7000}); }catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„'); } finally{ overlay.hide(); refresh(); } });
    document.querySelectorAll('.btn:not(.primary)').forEach(b=>b.onclick=async()=>{ const id=b.dataset.id; if(id){ try{ overlay.show(); await apiFetch(`/api/admin/reject/${id}`,{method:'POST'},{ retries:1, timeout:7000}); }catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø±ÙØ¶'); } finally{ overlay.hide(); refresh(); } }});

    const l = document.getElementById('lessons'); l.innerHTML='';
    lessons.forEach(s=>{ const d=document.createElement('div'); d.className='item enter'; d.textContent=`${s.subject} â€” ${s.date} ${s.time} â€” ${s.center}`; l.appendChild(d); });

    // Students list with Set/Change passcode action
    const studentsWrap = document.getElementById('students'); studentsWrap.innerHTML='';
    students.forEach(st=>{
      const d = document.createElement('div'); d.className='item enter';
      d.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
          <div>
            <strong>${st.fullName}</strong>
            <div style="color:var(--muted);font-size:.85rem">@${st.username} â€” ${st.stage||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} â€” ${st.center||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
          </div>
          <div style="display:flex;gap:.5rem">
            <button class="btn" data-id="${st.id}" data-action="set-pass">ğŸ”‘ ØªØ¹ÙŠÙŠÙ†/ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±Ù‘ÙŠ</button>
          </div>
        </div>`;
      studentsWrap.appendChild(d);
    });
    document.querySelectorAll('[data-action="set-pass"]').forEach(btn=>{
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        const pass = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±Ù‘ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (4 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)');
        if(!pass) return;
        try{
          overlay.show();
          const res = await apiFetch(`/api/admin/set-passcode/${id}`,{
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({passcode:pass})
          }, { retries:1, timeout:9000 });
          if(res.ok){ alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±Ù‘ÙŠ'); }
          else{ const j=await res.json(); alert(j.message||'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±Ù‘ÙŠ'); }
        }catch(e){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); }
        finally{ overlay.hide(); }
      };
    });
    const a = document.getElementById('ann'); a.innerHTML='';
    ann.forEach(n=>{ const d=document.createElement('div'); d.className='item enter'; d.textContent=n.text; a.appendChild(d); });
    }catch(err){
      console.error('Refresh failed', err);
      alert(err && err.name==='AbortError' ? 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø·Ù„Ø¨' : 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  }
  refresh();

  document.getElementById('addLesson').onclick=async()=>{
    const subject = document.getElementById('ls_subject').value;
    const date = document.getElementById('ls_date').value;
    const time = document.getElementById('ls_time').value;
    const center = document.getElementById('ls_center').value;
    const teacher = document.getElementById('ls_teacher').value;
    const duration = document.getElementById('ls_duration').value;
    
    if (!subject || !date || !time || !center) {
      alert('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©');
      return;
    }
    
    try {
      overlay.show();
      const res = await apiFetch('/api/admin/lessons',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({subject,date,time,center,teacher,duration})
      }, { retries:1, timeout:12000 });
      
      if (res.ok) {
        document.getElementById('ls_subject').value = '';
        document.getElementById('ls_date').value = '';
        document.getElementById('ls_time').value = '';
        document.getElementById('ls_center').value = '';
        alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­');
        refresh();
      } else {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³');
      }
    } catch (err) {
      alert(err && err.name==='AbortError' ? 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø·Ù„Ø¨' : 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
    } finally { overlay.hide(); }
  };
  
  document.getElementById('addAnn').onclick=async()=>{
    const title = document.getElementById('ann_title').value;
    const text = document.getElementById('ann_text').value;
    const type = document.getElementById('ann_type').value;
    const important = document.getElementById('ann_important').checked;
    
    if (!text.trim()) {
      alert('Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ø·Ù„ÙˆØ¨');
      return;
    }
    
    try {
      overlay.show();
      const res = await apiFetch('/api/admin/announcements',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({title,text,type,important})
      }, { retries:1, timeout:12000 });
      
      if (res.ok) {
        document.getElementById('ann_title').value = '';
        document.getElementById('ann_text').value = '';
        document.getElementById('ann_type').value = 'general';
        document.getElementById('ann_important').checked = false;
        alert('ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­');
        refresh();
      } else {
        alert('Ø®Ø·Ø£ ÙÙŠ Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');
      }
    } catch (err) {
      alert(err && err.name==='AbortError' ? 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø·Ù„Ø¨' : 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
    } finally { overlay.hide(); }
  };
  </script>
</body>
</html>